---
title: "Regression"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: journal
    code_folding: "hide"
---
<br>

<font size="4" color="black">

We first loaded the necessary packages to start on building regression models and the cleaned rat dataset 

```{r, message = FALSE}
library(tidyverse)
library(lubridate)
library(readr) 
library("ggplot2") 
library("dplyr")
library(xts)
library("lubridate")
library("RColorBrewer")
library("ggthemes")
library("gridExtra")
library("leaflet")
library("highcharter")
library(scales)
library(leaflet.extras)
library(modelr)
library(broom)

rats_raw <- read.csv("./Rat_Sightings.csv", na = c("", "NA", "N/A", "Unspecified")) %>%
  janitor::clean_names() %>% 
  mutate(created_date = mdy_hms(created_date)) %>%
  mutate(sighting_year = year(created_date),
         sighting_month_num = month(created_date),
         sighting_month = month(created_date, label = TRUE, abbr = FALSE),
         sighting_day = day(created_date),
         sighting_weekday = wday(created_date, label = TRUE, abbr = FALSE)) 
```

We did further literature research and found 3 variables that we thought would be useful in predicting the number of rats per month. 

```{r, results= FALSE}
rat_location <-
rats_raw %>%
  filter(location_type %in% c("3+ Family Apt. Building", "1-2 Family Dwelling", "3+ Family Mixed Use Building", "Commercial Building", "Vacant Lot", "Construction Site")) %>%
  group_by(location_type, sighting_month_num, sighting_year) %>%
  mutate(rat_per_month = n()) %>%
  slice(1) %>%
  select(location_type, sighting_month_num, sighting_year, rat_per_month) %>% 
  mutate(sighting_month_num = as.factor(sighting_month_num))
```

We built a model that predicts rats per month from sighting year, sighting month, and location type. 

```{r, results = FALSE}
model <- lm(rat_per_month ~ sighting_year + sighting_month_num + location_type, data = rat_location)
summary(model)
```

We then ran a k-fold cross-validation technique to create training and testing data sets and ran a new linear regression model for each of the training sets.

```{r, results = FALSE}
set.seed(23) 
rats_folds <- crossv_kfold(rat_location, k = 10)
rats_folds <- rats_folds %>% mutate(model = map(train, ~ lm(rat_per_month ~ ., data = .)))
```

We generated predictions using the models fitted during k-fold cross-validation. 

```{r, results = FALSE}
prediction <- 
  rats_folds %>%
  mutate(predicted = map2(model, train, ~ augment(.x, newdata = .y))) %>% 
  unnest(predicted)
prediction
```

We created a residual plot to visually assess the performance of our model.

```{r, message = FALSE}
prediction <- prediction %>% 
  mutate(residual = .fitted - rat_per_month)

prediction%>%
  ggplot(aes(rat_per_month, residual)) +
    geom_hline(yintercept = 0) +
    geom_point() +
    stat_smooth(method = "loess") +
    theme_minimal()
```


```{r, message = FALSE}
rs <- prediction %>%
  group_by(.id) %>% 
  summarise(
    sst = sum((rat_per_month - mean(rat_per_month)) ^ 2), # Sum of Squares Total
    sse = sum(residual ^ 2),          # Sum of Squares Residual/Error
    r.squared = 1 - sse / sst         # Proportion of variance accounted for
    )

rs %>% 
  ggplot(aes(r.squared, fill  = .id)) +
    geom_histogram() +
    geom_vline(aes(xintercept = mean(r.squared)))

```
